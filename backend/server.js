require("dotenv").config();
const express = require("express");
const mysql = require("mysql2");
const bodyParser = require("body-parser");
const cors = require("cors");

const app = express();
const port = 3000;
const host = "0.0.0.0";

app.use(cors());
app.use(bodyParser.json());

const db = mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
});

db.connect(err => {
    if (err) {
        console.error("Database connection error: ", err);
        return;
    }
    console.log("Connected to MySQL database");
});

//make table if it doesnt exist
const createTableQuery = `CREATE TABLE IF NOT EXISTS ph_readings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ph_value FLOAT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)`;

db.query(createTableQuery, (err) => {
    if (err) {
        console.error("Error creating table: ", err);
    }
});

//test data
const insertTestDataQuery = `
    INSERT INTO ph_readings (ph_value, timestamp) VALUES 
(5.25, '2024-03-02 19:48:37'),
(5.24, '2024-03-03 19:48:37'),
(5.30, '2024-03-04 19:48:37'),
(5.45, '2024-03-05 19:48:37'),
(5.43, '2024-03-06 19:48:37'),
(5.41, '2024-03-07 19:48:37'),
(5.56, '2024-03-08 19:48:37'),
(5.64, '2024-03-09 19:48:37'),
(5.59, '2024-03-10 19:48:37'),
(5.65, '2024-03-11 19:48:37'),
(5.60, '2024-03-12 19:48:37'),
(5.56, '2024-03-13 19:48:37'),
(5.58, '2024-03-14 19:48:37'),
(5.39, '2024-03-15 19:48:37'),
(5.22, '2024-03-16 19:48:37'),
(5.16, '2024-03-17 19:48:37'),
(5.06, '2024-03-18 19:48:37'),
(5.09, '2024-03-19 19:48:37'),
(5.00, '2024-03-20 19:48:37'),
(4.86, '2024-03-21 19:48:37'),
(5.00, '2024-03-22 19:48:37'),
(4.98, '2024-03-23 19:48:37'),
(4.99, '2024-03-24 19:48:37'),
(4.85, '2024-03-25 19:48:37'),
(4.79, '2024-03-26 19:48:37'),
(4.80, '2024-03-27 19:48:37'),
(4.70, '2024-03-28 19:48:37'),
(4.72, '2024-03-29 19:48:37'),
(4.70, '2024-03-30 19:48:37'),
(4.70, '2024-03-31 19:48:37'),
(4.70, '2024-04-01 19:48:37'),
(4.76, '2024-04-02 19:48:37'),
(4.76, '2024-04-03 19:48:37'),
(4.70, '2024-04-04 19:48:37'),
(4.74, '2024-04-05 19:48:37'),
(4.70, '2024-04-06 19:48:37'),
(4.70, '2024-04-07 19:48:37'),
(4.70, '2024-04-08 19:48:37'),
(4.70, '2024-04-09 19:48:37'),
(4.70, '2024-04-10 19:48:37'),
(4.70, '2024-04-11 19:48:37'),
(4.70, '2024-04-12 19:48:37'),
(4.70, '2024-04-13 19:48:37'),
(4.70, '2024-04-14 19:48:37'),
(4.70, '2024-04-15 19:48:37'),
(4.70, '2024-04-16 19:48:37'),
(4.70, '2024-04-17 19:48:37'),
(4.70, '2024-04-18 19:48:37'),
(4.70, '2024-04-19 19:48:37'),
(4.70, '2024-04-20 19:48:37'),
(4.70, '2024-04-21 19:48:37'),
(4.70, '2024-04-22 19:48:37'),
(4.70, '2024-04-23 19:48:37'),
(4.70, '2024-04-24 19:48:37'),
(4.70, '2024-04-25 19:48:37'),
(4.70, '2024-04-26 19:48:37'),
(4.70, '2024-04-27 19:48:37'),
(4.70, '2024-04-28 19:48:37'),
(4.70, '2024-04-29 19:48:37'),
(4.70, '2024-04-30 19:48:37'),
(4.70, '2024-05-01 19:48:37'),
(4.70, '2024-05-02 19:48:37'),
(4.70, '2024-05-03 19:48:37'),
(4.70, '2024-05-04 19:48:37'),
(4.70, '2024-05-05 19:48:37'),
(4.70, '2024-05-06 19:48:37'),
(4.70, '2024-05-07 19:48:37'),
(4.70, '2024-05-08 19:48:37'),
(4.70, '2024-05-09 19:48:37'),
(4.70, '2024-05-10 19:48:37'),
(4.70, '2024-05-11 19:48:37'),
(4.70, '2024-05-12 19:48:37'),
(4.70, '2024-05-13 19:48:37'),
(4.70, '2024-05-14 19:48:37'),
(4.70, '2024-05-15 19:48:37'),
(4.70, '2024-05-16 19:48:37'),
(4.70, '2024-05-17 19:48:37'),
(4.70, '2024-05-18 19:48:37'),
(4.70, '2024-05-19 19:48:37'),
(4.70, '2024-05-20 19:48:37'),
(4.70, '2024-05-21 19:48:37'),
(4.70, '2024-05-22 19:48:37'),
(4.70, '2024-05-23 19:48:37'),
(4.70, '2024-05-24 19:48:37'),
(4.70, '2024-05-25 19:48:37'),
(4.70, '2024-05-26 19:48:37'),
(4.70, '2024-05-27 19:48:37'),
(4.70, '2024-05-28 19:48:37'),
(4.70, '2024-05-29 19:48:37'),
(4.70, '2024-05-30 19:48:37'),
(4.70, '2024-05-31 19:48:37'),
(4.70, '2024-06-01 19:48:37'),
(4.70, '2024-06-02 19:48:37'),
(4.70, '2024-06-03 19:48:37'),
(4.70, '2024-06-04 19:48:37'),
(4.70, '2024-06-05 19:48:37'),
(4.70, '2024-06-06 19:48:37'),
(4.70, '2024-06-07 19:48:37'),
(4.70, '2024-06-08 19:48:37'),
(4.70, '2024-06-09 19:48:37'),
(4.70, '2024-06-10 19:48:37'),
(4.70, '2024-06-11 19:48:37'),
(4.70, '2024-06-12 19:48:37'),
(4.70, '2024-06-13 19:48:37'),
(4.70, '2024-06-14 19:48:37'),
(4.70, '2024-06-15 19:48:37'),
(4.70, '2024-06-16 19:48:37'),
(4.70, '2024-06-17 19:48:37'),
(4.70, '2024-06-18 19:48:37'),
(4.70, '2024-06-19 19:48:37'),
(4.70, '2024-06-20 19:48:37'),
(4.70, '2024-06-21 19:48:37'),
(4.70, '2024-06-22 19:48:37'),
(4.70, '2024-06-23 19:48:37'),
(4.70, '2024-06-24 19:48:37'),
(4.70, '2024-06-25 19:48:37'),
(4.70, '2024-06-26 19:48:37'),
(4.70, '2024-06-27 19:48:37'),
(4.70, '2024-06-28 19:48:37'),
(4.70, '2024-06-29 19:48:37'),
(4.70, '2024-06-30 19:48:37'),
(4.70, '2024-07-01 19:48:37'),
(4.70, '2024-07-02 19:48:37'),
(4.70, '2024-07-03 19:48:37'),
(4.70, '2024-07-04 19:48:37'),
(4.70, '2024-07-05 19:48:37'),
(4.70, '2024-07-06 19:48:37'),
(4.70, '2024-07-07 19:48:37'),
(4.70, '2024-07-08 19:48:37'),
(4.70, '2024-07-09 19:48:37'),
(4.70, '2024-07-10 19:48:37'),
(4.70, '2024-07-11 19:48:37'),
(4.70, '2024-07-12 19:48:37'),
(4.70, '2024-07-13 19:48:37'),
(4.70, '2024-07-14 19:48:37'),
(4.70, '2024-07-15 19:48:37'),
(4.70, '2024-07-16 19:48:37'),
(4.70, '2024-07-17 19:48:37'),
(4.70, '2024-07-18 19:48:37'),
(4.70, '2024-07-19 19:48:37'),
(4.70, '2024-07-20 19:48:37'),
(4.70, '2024-07-21 19:48:37'),
(4.70, '2024-07-22 19:48:37'),
(4.70, '2024-07-23 19:48:37'),
(4.70, '2024-07-24 19:48:37'),
(4.70, '2024-07-25 19:48:37'),
(4.70, '2024-07-26 19:48:37'),
(4.70, '2024-07-27 19:48:37'),
(4.70, '2024-07-28 19:48:37'),
(4.70, '2024-07-29 19:48:37'),
(4.70, '2024-07-30 19:48:37'),
(4.70, '2024-07-31 19:48:37'),
(4.70, '2024-08-01 19:48:37'),
(4.70, '2024-08-02 19:48:37'),
(4.70, '2024-08-03 19:48:37'),
(4.70, '2024-08-04 19:48:37'),
(4.70, '2024-08-05 19:48:37'),
(4.70, '2024-08-06 19:48:37'),
(4.70, '2024-08-07 19:48:37'),
(4.70, '2024-08-08 19:48:37'),
(4.70, '2024-08-09 19:48:37'),
(4.70, '2024-08-10 19:48:37'),
(4.70, '2024-08-11 19:48:37'),
(4.70, '2024-08-12 19:48:37'),
(4.70, '2024-08-13 19:48:37'),
(4.70, '2024-08-14 19:48:37'),
(4.70, '2024-08-15 19:48:37'),
(4.70, '2024-08-16 19:48:37'),
(4.70, '2024-08-17 19:48:37'),
(4.70, '2024-08-18 19:48:37'),
(4.70, '2024-08-19 19:48:37'),
(4.70, '2024-08-20 19:48:37'),
(4.70, '2024-08-21 19:48:37'),
(4.70, '2024-08-22 19:48:37'),
(4.70, '2024-08-23 19:48:37'),
(4.70, '2024-08-24 19:48:37'),
(4.70, '2024-08-25 19:48:37'),
(4.70, '2024-08-26 19:48:37'),
(4.70, '2024-08-27 19:48:37'),
(4.80, '2024-08-28 19:48:37'),
(4.86, '2024-08-29 19:48:37'),
(4.78, '2024-08-30 19:48:37'),
(4.70, '2024-08-31 19:48:37'),
(4.72, '2024-09-01 19:48:37'),
(4.70, '2024-09-02 19:48:37'),
(4.77, '2024-09-03 19:48:37'),
(4.82, '2024-09-04 19:48:37'),
(4.81, '2024-09-05 19:48:37'),
(4.72, '2024-09-06 19:48:37'),
(4.70, '2024-09-07 19:48:37'),
(4.70, '2024-09-08 19:48:37'),
(4.70, '2024-09-09 19:48:37'),
(4.70, '2024-09-10 19:48:37'),
(4.70, '2024-09-11 19:48:37'),
(4.70, '2024-09-12 19:48:37'),
(4.70, '2024-09-13 19:48:37'),
(4.70, '2024-09-14 19:48:37'),
(4.70, '2024-09-15 19:48:37'),
(4.70, '2024-09-16 19:48:37'),
(4.70, '2024-09-17 19:48:37'),
(4.70, '2024-09-18 19:48:37'),
(4.70, '2024-09-19 19:48:37'),
(4.70, '2024-09-20 19:48:37'),
(4.70, '2024-09-21 19:48:37'),
(4.70, '2024-09-22 19:48:37'),
(4.70, '2024-09-23 19:48:37'),
(4.70, '2024-09-24 19:48:37'),
(4.70, '2024-09-25 19:48:37'),
(4.70, '2024-09-26 19:48:37'),
(5.00, '2024-09-27 19:48:37'),
(5.06, '2024-09-28 19:48:37'),
(5.17, '2024-09-29 19:48:37'),
(5.26, '2024-09-30 19:48:37'),
(5.33, '2024-10-01 19:48:37'),
(5.30, '2024-10-02 19:48:37'),
(5.37, '2024-10-03 19:48:37'),
(5.30, '2024-10-04 19:48:37'),
(5.27, '2024-10-05 19:48:37'),
(5.22, '2024-10-06 19:48:37'),
(5.23, '2024-10-07 19:48:37'),
(5.46, '2024-10-08 19:48:37'),
(5.28, '2024-10-09 19:48:37'),
(5.35, '2024-10-10 19:48:37'),
(5.18, '2024-10-11 19:48:37'),
(5.14, '2024-10-12 19:48:37'),
(5.25, '2024-10-13 19:48:37'),
(5.25, '2024-10-14 19:48:37'),
(5.14, '2024-10-15 19:48:37'),
(5.07, '2024-10-16 19:48:37'),
(5.14, '2024-10-17 19:48:37'),
(5.07, '2024-10-18 19:48:37'),
(5.09, '2024-10-19 19:48:37'),
(5.09, '2024-10-20 19:48:37'),
(5.03, '2024-10-21 19:48:37'),
(5.24, '2024-10-22 19:48:37'),
(5.31, '2024-10-23 19:48:37'),
(5.10, '2024-10-24 19:48:37'),
(5.12, '2024-10-25 19:48:37'),
(5.06, '2024-10-26 19:48:37'),
(5.14, '2024-10-27 19:48:37'),
(5.06, '2024-10-28 19:48:37'),
(5.05, '2024-10-29 19:48:37'),
(5.10, '2024-10-30 19:48:37'),
(5.19, '2024-10-31 19:48:37'),
(5.07, '2024-11-01 19:48:37'),
(5.04, '2024-11-02 19:48:37'),
(4.99, '2024-11-03 19:48:37'),
(4.92, '2024-11-04 19:48:37'),
(5.10, '2024-11-05 19:48:37'),
(5.14, '2024-11-06 19:48:37'),
(5.01, '2024-11-07 19:48:37'),
(5.11, '2024-11-08 19:48:37'),
(5.32, '2024-11-09 19:48:37'),
(5.42, '2024-11-10 19:48:37'),
(5.27, '2024-11-11 19:48:37'),
(5.22, '2024-11-12 19:48:37'),
(5.35, '2024-11-13 19:48:37'),
(5.28, '2024-11-14 19:48:37'),
(5.32, '2024-11-15 19:48:37'),
(5.40, '2024-11-16 19:48:37'),
(5.31, '2024-11-17 19:48:37'),
(5.30, '2024-11-18 19:48:37'),
(4.98, '2024-11-19 19:48:37'),
(4.87, '2024-11-20 19:48:37'),
(4.85, '2024-11-21 19:48:37'),
(4.72, '2024-11-22 19:48:37'),
(4.89, '2024-11-23 19:48:37'),
(4.74, '2024-11-24 19:48:37'),
(4.70, '2024-11-25 19:48:37'),
(4.71, '2024-11-26 19:48:37'),
(4.86, '2024-11-27 19:48:37'),
(4.71, '2024-11-28 19:48:37'),
(4.83, '2024-11-29 19:48:37'),
(4.83, '2024-11-30 19:48:37'),
(4.73, '2024-12-01 19:48:37'),
(4.78, '2024-12-02 19:48:37'),
(4.80, '2024-12-03 19:48:37'),
(4.74, '2024-12-04 19:48:37'),
(4.74, '2024-12-05 19:48:37'),
(4.71, '2024-12-06 19:48:37'),
(4.72, '2024-12-07 19:48:37'),
(4.78, '2024-12-08 19:48:37'),
(4.94, '2024-12-09 19:48:37'),
(4.82, '2024-12-10 19:48:37'),
(5.03, '2024-12-11 19:48:37'),
(4.84, '2024-12-12 19:48:37'),
(4.82, '2024-12-13 19:48:37'),
(4.88, '2024-12-14 19:48:37'),
(4.91, '2024-12-15 19:48:37'),
(4.85, '2024-12-16 19:48:37'),
(4.83, '2024-12-17 19:48:37'),
(4.78, '2024-12-18 19:48:37'),
(4.72, '2024-12-19 19:48:37'),
(4.80, '2024-12-20 19:48:37'),
(4.84, '2024-12-21 19:48:37'),
(4.77, '2024-12-22 19:48:37'),
(4.86, '2024-12-23 19:48:37'),
(4.89, '2024-12-24 19:48:37'),
(4.97, '2024-12-25 19:48:37'),
(5.03, '2024-12-26 19:48:37'),
(4.95, '2024-12-27 19:48:37'),
(4.89, '2024-12-28 19:48:37'),
(4.97, '2024-12-29 19:48:37'),
(5.03, '2024-12-30 19:48:37'),
(5.03, '2024-12-31 19:48:37'),
(5.04, '2025-01-01 19:48:37'),
(5.17, '2025-01-02 19:48:37'),
(5.11, '2025-01-03 19:48:37'),
(5.16, '2025-01-04 19:48:37'),
(5.14, '2025-01-05 19:48:37'),
(5.12, '2025-01-06 19:48:37'),
(5.23, '2025-01-07 19:48:37'),
(5.31, '2025-01-08 19:48:37'),
(5.40, '2025-01-09 19:48:37'),
(5.53, '2025-01-10 19:48:37'),
(5.53, '2025-01-11 19:48:37'),
(5.60, '2025-01-12 19:48:37'),
(5.56, '2025-01-13 19:48:37'),
(5.60, '2025-01-14 19:48:37'),
(5.58, '2025-01-15 19:48:37'),
(5.59, '2025-01-16 19:48:37'),
(5.65, '2025-01-17 19:48:37'),
(5.57, '2025-01-18 19:48:37'),
(5.75, '2025-01-19 19:48:37'),
(5.68, '2025-01-20 19:48:37'),
(5.56, '2025-01-21 19:48:37'),
(5.67, '2025-01-22 19:48:37'),
(5.75, '2025-01-23 19:48:37'),
(5.75, '2025-01-24 19:48:37'),
(5.75, '2025-01-25 19:48:37'),
(5.75, '2025-01-26 19:48:37'),
(5.75, '2025-01-27 19:48:37'),
(5.75, '2025-01-28 19:48:37'),
(5.73, '2025-01-29 19:48:37'),
(5.75, '2025-01-30 19:48:37'),
(5.75, '2025-01-31 19:48:37'),
(5.73, '2025-02-01 19:48:37'),
(5.70, '2025-02-02 19:48:37'),
(5.74, '2025-02-03 19:48:37'),
(5.68, '2025-02-04 19:48:37'),
(5.60, '2025-02-05 19:48:37'),
(5.62, '2025-02-06 19:48:37'),
(5.65, '2025-02-07 19:48:37'),
(5.60, '2025-02-08 19:48:37'),
(5.55, '2025-02-09 19:48:37'),
(5.57, '2025-02-10 19:48:37'),
(5.43, '2025-02-11 19:48:37'),
(5.29, '2025-02-12 19:48:37'),
(5.22, '2025-02-13 19:48:37'),
(5.19, '2025-02-14 19:48:37'),
(5.23, '2025-02-15 19:48:37'),
(5.37, '2025-02-16 19:48:37'),
(5.46, '2025-02-17 19:48:37'),
(5.44, '2025-02-18 19:48:37'),
(5.44, '2025-02-19 19:48:37'),
(5.34, '2025-02-20 19:48:37'),
(5.34, '2025-02-21 19:48:37'),
(5.31, '2025-02-22 19:48:37'),
(5.34, '2025-02-23 19:48:37'),
(5.26, '2025-02-24 19:48:37'),
(5.31, '2025-02-25 19:48:37'),
(5.46, '2025-02-26 19:48:37'),
(5.45, '2025-02-27 19:48:37'),
(5.49, '2025-02-28 19:48:37'),
(5.56, '2025-03-01 19:48:37');
`;

db.query(insertTestDataQuery, (err) => {
    if (err) {
        console.error("Error inserting test data: ", err);
    } else {
        console.log("Test data inserted successfully");
    }
});

// Endpoint to receive pH data
app.post("/api/ph-data", (req, res) => {
    const { ph } = req.body;
    if (!ph) {
        return res.status(400).json({ message: "Missing pH value" });
    }
    
    const insertQuery = "INSERT INTO ph_readings (ph_value) VALUES (?)";
    db.query(insertQuery, [ph], (err, result) => {
        if (err) {
            return res.status(500).json({ message: "Database error", error: err });
        }
        res.json({ message: "pH value saved successfully", id: result.insertId, ph });
    });
});

// Endpoint to fetch pH history
app.get("/api/ph-history", (req, res) => {
    db.query("SELECT * FROM ph_readings ORDER BY timestamp DESC", (err, results) => {
        if (err) {
            return res.status(500).json({ message: "Database error", error: err });
        }
        res.json(results);
    });
});

app.listen(port, host, () => {
    console.log(`Server running at http://${host}:${port}`);
});